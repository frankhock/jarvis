# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Jarvis is a Rails 8.1 + React 19 application using Inertia.js as the bridge layer (no separate API). Built from the Inertia Rails React Starter Kit. Ruby 4.0, SQLite, Tailwind CSS 4, shadcn/ui (new-york style), TypeScript.

## Commands

### Development
```bash
bin/setup              # Install deps, prepare DB, start dev server
bin/dev                # Start dev server (Rails + Vite via Procfile.dev)
bin/rails s -p 3000    # Rails server only
bin/vite dev           # Vite dev server only
```

### Testing
```bash
bin/rails spec                           # Run all RSpec tests
bin/rails spec SPEC=spec/requests/sessions_spec.rb  # Run single spec file
bin/rails spec SPEC=spec/requests/sessions_spec.rb:15  # Run specific line
bin/rails db:test:prepare                # Prepare test DB before running tests
```

### Linting & Formatting
```bash
bin/rubocop            # Ruby linting (rubocop-rails-omakase)
bin/rubocop -a         # Ruby lint with autocorrect
npm run lint           # ESLint (TypeScript + React)
npm run lint:fix       # ESLint with autofix
npm run format         # Prettier check
npm run format:fix     # Prettier write
npm run check          # TypeScript type checking (both app and node configs)
bin/brakeman           # Security static analysis
bin/bundler-audit      # Gem vulnerability audit
```

## Architecture

### Inertia.js Bridge Pattern
Controllers inherit from `InertiaController` (which extends `ApplicationController`) to get `default_render: true` — the controller action name automatically resolves to the matching React page component. No explicit `render` calls needed. Shared auth data (user + session) is injected into all Inertia responses via `inertia_share`.

### Frontend Structure (`app/frontend/`)
- `pages/` — Inertia page components, mirroring Rails controller paths (e.g., `dashboard/index.tsx` maps to `DashboardController#index`)
- `components/` — App components; `components/ui/` are shadcn/ui primitives
- `layouts/` — `PersistentLayout` wraps all pages (flash toasts + Sonner); `AppLayout` provides the sidebar shell for authenticated pages
- `hooks/` — Custom React hooks (appearance/theme, flash messages, clipboard, mobile detection)
- `types/index.ts` — Shared TypeScript interfaces (`Auth`, `User`, `Session`, `SharedData`, etc.)
- `routes/` — Auto-generated by `js-routes` gem (excluded from ESLint); provides type-safe Rails route helpers in JS
- `entrypoints/inertia.tsx` — Inertia app bootstrap with page resolution via `import.meta.glob`
- `lib/utils.ts` — Utility functions (cn helper for class merging)

Path aliases: `@/*` and `~/*` both resolve to `app/frontend/*`.

### Authentication
Cookie-based sessions using `has_secure_password` (bcrypt). No Devise. The `Current` model (CurrentAttributes) holds session/user/request info. `ApplicationController` runs `authenticate` before_action on all routes. Auth pages (sign in/up, password reset) use `require_no_authentication` to skip.

### Models
- `User` — name, email, password_digest, verified flag. Token generation for email verification and password reset.
- `Session` — belongs_to user, tracks user_agent and ip_address.
- `Current` — CurrentAttributes singleton for request-scoped state.

### Routing
Routes use typed helpers via `js-routes` gem. Route file regenerated on `assets:precompile`. Use `Routes.dashboardPath()` etc. in frontend code.

## Code Style

### Ruby
- Rubocop with `rubocop-rails-omakase` base config
- Double quotes for strings (`Style/StringLiterals: double_quotes`)
- Frozen string literal comments required
- 2-space indentation

### TypeScript/React
- Prettier: no semicolons, 2-space indent, trailing commas
- ESLint enforces import ordering (external → `@/` aliased → relative) with newlines between groups
- `@typescript-eslint/consistent-type-imports` required (use `import type` for type-only imports)
- React Compiler enabled via babel plugin

### shadcn/ui
Config in `components.json`. To add components: `npx shadcn@latest add <component>`. Uses `new-york` style, `neutral` base color, CSS variables, lucide icons.

## Testing
- RSpec with FactoryBot, Capybara + Selenium (headless Chrome) for system tests
- `AuthenticationHelpers` module provides `sign_in_as(user)` and `sign_out` for request/system specs
- Vite assets are precompiled once before the test suite runs (`ViteRuby.commands.build` in `rails_helper.rb`)

## Deployment
Kamal-based Docker deployment. Two Dockerfiles: `Dockerfile` (standard) and `Dockerfile-ssr` (with SSR support).
